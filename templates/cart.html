{% if cart_items %}
    <table>
        <thead>
            <tr>
                <th>Livre</th>
                <th>Prix</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for item in cart_items %}
            <tr>
                <td>{{ item.book.book_title }}</td>
                <td>{{ item.book.book_price }} €</td>
                <td>
                    <form action="{{ url_for('cart_bp.remove_from_cart', cart_item_id=item.cart_item_id) }}" method="post">
                        <button type="submit">Retirer</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <p>Total : <strong>{{ total_price }} €</strong></p>

    <!-- Utilisation d'un formulaire avec id "cart-validation-form" -->
    <form id="cart-validation-form" action="{{ url_for('cart_bp.validate_cart') }}" method="post">
        <button id="validate-cart-btn" type="button">Valider le panier</button>
    </form>

    <script>
        document.getElementById("validate-cart-btn").addEventListener("click", function(event) {
            event.preventDefault();  // Empêche le rechargement de la page
    
            fetch("{{ url_for('cart_bp.validate_cart') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.redirect_url) {
                    // Faire une requête POST vers Stripe en JavaScript
                    fetch(data.redirect_url, { method: "POST" })
                        .then(response => response.json())
                        .then(paymentData => {
                            if (paymentData.url) {
                                window.location.href = paymentData.url;  // Redirection vers Stripe
                            } else {
                                alert("Erreur de paiement.");
                            }
                        })
                        .catch(error => console.error("Erreur Stripe :", error));
                } else {
                    alert("Erreur lors de la validation du panier.");
                }
            })
            .catch(error => console.error("Erreur :", error));
        });
    </script>
    

{% else %}
    <p>Votre panier est vide.</p>
{% endif %}
